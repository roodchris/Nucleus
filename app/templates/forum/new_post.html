{% extends "base.html" %}
{% block content %}
  <div class="job-card" style="padding:24px;">
    <h2 style="margin-top:0;">Create New Post</h2>
    <p class="muted">Share your thoughts, questions, or advice with the community</p>
  </div>

  <div class="job-card" style="padding:24px; margin-top:20px;">
    <form method="POST" id="postForm" enctype="multipart/form-data">
      <div style="display:grid; gap:20px;">
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:500;">Title *</label>
          <input type="text" name="title" class="input" placeholder="Enter a descriptive title for your post" required>
        </div>
        
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:500;">Category *</label>
          <select name="category" class="input" required>
            <option value="">Select a category</option>
            {% for category in categories %}
              <option value="{{ category.value }}">{{ category.value.replace('_', ' ').title() }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:500;">Medical Specialty (Optional)</label>
          <select name="specialty" class="input">
            <option value="">General (All Specialties)</option>
            <option value="non_clinical_other">Non-clinical/Other</option>
            <option value="aerospace_medicine">Aerospace Medicine</option>
            <option value="anesthesiology">Anesthesiology</option>
            <option value="child_neurology">Child Neurology</option>
            <option value="dermatology">Dermatology</option>
            <option value="emergency_medicine">Emergency Medicine</option>
            <option value="family_medicine">Family Medicine</option>
            <option value="internal_medicine">Internal Medicine</option>
            <option value="medical_genetics">Medical Genetics</option>
            <option value="interventional_radiology">Interventional Radiology</option>
            <option value="neurological_surgery">Neurological Surgery</option>
            <option value="neurology">Neurology</option>
            <option value="nuclear_medicine">Nuclear Medicine</option>
            <option value="obstetrics_gynecology">Obstetrics and Gynecology</option>
            <option value="occupational_environmental_medicine">Occupational and Environmental Medicine</option>
            <option value="orthopaedic_surgery">Orthopaedic Surgery</option>
            <option value="otolaryngology">Otolaryngology - Head and Neck Surgery</option>
            <option value="pathology">Pathology-Anatomic and Clinical</option>
            <option value="pediatrics">Pediatrics</option>
            <option value="physical_medicine_rehabilitation">Physical Medicine and Rehabilitation</option>
            <option value="plastic_surgery">Plastic Surgery</option>
            <option value="psychiatry">Psychiatry</option>
            <option value="radiation_oncology">Radiation Oncology</option>
            <option value="radiology_diagnostic">Radiology-Diagnostic</option>
            <option value="general_surgery">General Surgery</option>
            <option value="thoracic_surgery">Thoracic Surgery</option>
            <option value="urology">Urology</option>
            <option value="vascular_surgery">Vascular Surgery</option>
          </select>
          <div style="margin-top:8px; font-size:14px; color:#888;">
            Select a specialty if your post is specific to that field, or leave as "General" for all specialties.
          </div>
        </div>
        
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:500;">Content *</label>
          <textarea name="content" class="input" rows="10" placeholder="Write your post content here..." required></textarea>
          <div style="margin-top:8px; font-size:14px; color:#888;">
            You can use basic formatting. Be respectful and helpful to the community.
          </div>
        </div>
        
        <!-- Photo Upload Section -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:500;">Photos (Optional)</label>
          <div id="photoUploadArea" style="border: 2px dashed #4a5568; border-radius: 8px; padding: 20px; text-align: center; background: rgba(255,255,255,0.02);">
            <div id="photoUploadText">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto 12px; opacity: 0.6;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="17,8 12,3 7,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <p style="margin: 0; color: #888; font-size: 14px;">Click to upload photos or drag and drop</p>
              <p style="margin: 4px 0 0; color: #666; font-size: 12px;">PNG, JPG, JPEG, GIF, WEBP up to 5MB each (max 5 photos)</p>
            </div>
            <input type="file" id="photoInput" name="photos" multiple accept="image/*" style="display: none;">
            <input type="hidden" name="photos" id="photosData" value="[]">
          </div>
          
          <!-- Photo Preview Area -->
          <div id="photoPreview" style="margin-top: 16px; display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
              <!-- Photos will be added here dynamically -->
            </div>
          </div>
        </div>
        
        <div style="display:flex; gap:12px;">
          <button type="submit" class="btn">Create Post</button>
          <a href="/forum" class="btn" style="background:rgba(17,24,39,0.6);">Cancel</a>
        </div>
      </div>
    </form>
  </div>

  <div class="job-card" style="padding:24px; margin-top:20px;">
    <h3>Posting Guidelines</h3>
    <ul style="margin:0; padding-left:20px; line-height:1.6;">
      <li>Be respectful and professional</li>
      <li>Use appropriate categories for your posts</li>
      <li>Provide helpful and constructive content</li>
      <li>Respect patient privacy and confidentiality</li>
      <li>No spam or promotional content</li>
    </ul>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const photoInput = document.getElementById('photoInput');
      const photoUploadArea = document.getElementById('photoUploadArea');
      const photoPreview = document.getElementById('photoPreview');
      const photosData = document.getElementById('photosData');
      const postForm = document.getElementById('postForm');
      
      let uploadedPhotos = [];
      const MAX_PHOTOS = 5;
      const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
      
      // Click to upload
      photoUploadArea.addEventListener('click', () => {
        photoInput.click();
      });
      
      // Drag and drop
      photoUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        photoUploadArea.style.borderColor = '#00d4ff';
        photoUploadArea.style.backgroundColor = 'rgba(0, 212, 255, 0.1)';
      });
      
      photoUploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        photoUploadArea.style.borderColor = '#4a5568';
        photoUploadArea.style.backgroundColor = 'rgba(255,255,255,0.02)';
      });
      
      photoUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        photoUploadArea.style.borderColor = '#4a5568';
        photoUploadArea.style.backgroundColor = 'rgba(255,255,255,0.02)';
        
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
      });
      
      // File input change
      photoInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
      });
      
      function handleFiles(files) {
        if (uploadedPhotos.length + files.length > MAX_PHOTOS) {
          alert(`Maximum ${MAX_PHOTOS} photos allowed`);
          return;
        }
        
        files.forEach(file => {
          if (!file.type.startsWith('image/')) {
            alert(`${file.name} is not an image file`);
            return;
          }
          
          if (file.size > MAX_FILE_SIZE) {
            alert(`${file.name} is too large. Maximum size is 5MB`);
            return;
          }
          
          uploadPhoto(file);
        });
      }
      
      function uploadPhoto(file) {
        const formData = new FormData();
        formData.append('photo', file);
        
        fetch('/api/upload-photo', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            uploadedPhotos.push({
              filename: data.filename,
              url: data.url,
              originalName: file.name
            });
            updatePhotoPreview();
            updatePhotosData();
          } else {
            alert(`Error uploading ${file.name}: ${data.error}`);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert(`Error uploading ${file.name}`);
        });
      }
      
      function updatePhotoPreview() {
        if (uploadedPhotos.length === 0) {
          photoPreview.style.display = 'none';
          return;
        }
        
        photoPreview.style.display = 'block';
        const previewContainer = photoPreview.querySelector('div');
        previewContainer.innerHTML = '';
        
        uploadedPhotos.forEach((photo, index) => {
          const photoDiv = document.createElement('div');
          photoDiv.style.position = 'relative';
          photoDiv.style.borderRadius = '8px';
          photoDiv.style.overflow = 'hidden';
          photoDiv.style.backgroundColor = '#1a202c';
          
          photoDiv.innerHTML = `
            <img src="${photo.url}" alt="${photo.originalName}" 
                 style="width: 100%; height: 120px; object-fit: cover; display: block;">
            <button type="button" class="remove-photo" 
                    style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); 
                           color: white; border: none; border-radius: 50%; width: 24px; height: 24px; 
                           cursor: pointer; font-size: 14px; display: flex; align-items: center; 
                           justify-content: center;">×</button>
          `;
          
          photoDiv.querySelector('.remove-photo').addEventListener('click', () => {
            removePhoto(index);
          });
          
          previewContainer.appendChild(photoDiv);
        });
      }
      
      function removePhoto(index) {
        const photo = uploadedPhotos[index];
        
        // Delete from server
        fetch('/api/delete-photo', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ filename: photo.filename })
        });
        
        uploadedPhotos.splice(index, 1);
        updatePhotoPreview();
        updatePhotosData();
      }
      
      function updatePhotosData() {
        photosData.value = JSON.stringify(uploadedPhotos.map(p => p.filename));
      }
      
      // Form submission
      postForm.addEventListener('submit', function(e) {
        if (uploadedPhotos.length > MAX_PHOTOS) {
          e.preventDefault();
          alert(`Maximum ${MAX_PHOTOS} photos allowed`);
          return;
        }
      });
    });
  </script>
{% endblock %}
