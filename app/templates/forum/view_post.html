{% extends "base.html" %}

{% block title %}{{ post.title }} - Forum{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title page-title-animated">ðŸ’¬ {{ post.title }}</h1>
</div>

<!-- Post Content Card -->
<div class="post-card">
  <div class="post-header">
    <div class="post-meta">
      <div class="post-author">
        <div class="author-avatar">
          <span>{{ post.author.name[0].upper() }}</span>
        </div>
        <div class="author-info">
          <div class="author-name">{{ post.author.name }}</div>
          <div class="post-date" data-timestamp="{{ post.created_at.isoformat() }}" data-format="full">{{ post.created_at.strftime('%B %d, %Y at %I:%M %p') }}</div>
        </div>
      </div>
      <div class="post-category">
        <span class="category-badge">{{ post.category.value.replace('_', ' ').title() }}</span>
        {% if post.specialty %}
          <span class="specialty-badge">
            {% if post.specialty == 'AEROSPACE_MEDICINE' %}Aerospace Medicine
            {% elif post.specialty == 'ANESTHESIOLOGY' %}Anesthesiology
            {% elif post.specialty == 'CHILD_NEUROLOGY' %}Child Neurology
            {% elif post.specialty == 'DERMATOLOGY' %}Dermatology
            {% elif post.specialty == 'EMERGENCY_MEDICINE' %}Emergency Medicine
            {% elif post.specialty == 'FAMILY_MEDICINE' %}Family Medicine
            {% elif post.specialty == 'INTERNAL_MEDICINE' %}Internal Medicine
            {% elif post.specialty == 'MEDICAL_GENETICS' %}Medical Genetics
            {% elif post.specialty == 'INTERVENTIONAL_RADIOLOGY' %}Interventional Radiology
            {% elif post.specialty == 'NEUROLOGICAL_SURGERY' %}Neurological Surgery
            {% elif post.specialty == 'NEUROLOGY' %}Neurology
            {% elif post.specialty == 'NUCLEAR_MEDICINE' %}Nuclear Medicine
            {% elif post.specialty == 'OBSTETRICS_GYNECOLOGY' %}Obstetrics and Gynecology
            {% elif post.specialty == 'OCCUPATIONAL_ENVIRONMENTAL_MEDICINE' %}Occupational and Environmental Medicine
            {% elif post.specialty == 'ORTHOPAEDIC_SURGERY' %}Orthopaedic Surgery
            {% elif post.specialty == 'OTOLARYNGOLOGY' %}Otolaryngology - Head and Neck Surgery
            {% elif post.specialty == 'PATHOLOGY' %}Pathology-Anatomic and Clinical
            {% elif post.specialty == 'PEDIATRICS' %}Pediatrics
            {% elif post.specialty == 'PHYSICAL_MEDICINE_REHABILITATION' %}Physical Medicine and Rehabilitation
            {% elif post.specialty == 'PLASTIC_SURGERY' %}Plastic Surgery
            {% elif post.specialty == 'PSYCHIATRY' %}Psychiatry
            {% elif post.specialty == 'RADIATION_ONCOLOGY' %}Radiation Oncology
            {% elif post.specialty == 'RADIOLOGY_DIAGNOSTIC' %}Radiology-Diagnostic
            {% elif post.specialty == 'GENERAL_SURGERY' %}General Surgery
            {% elif post.specialty == 'THORACIC_SURGERY' %}Thoracic Surgery
            {% elif post.specialty == 'UROLOGY' %}Urology
            {% elif post.specialty == 'VASCULAR_SURGERY' %}Vascular Surgery
            {% else %}{{ post.specialty.replace('_', ' ').title() }}
            {% endif %}
          </span>
        {% endif %}
      </div>
    </div>
    {% if current_user.is_authenticated and current_user.id == post.author_id %}
    <div class="post-actions">
      <button class="action-btn edit-btn" onclick="showEditPost()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Edit
      </button>
      <button class="action-btn delete-btn" onclick="deletePost({{ post.id }})">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Delete
      </button>
    </div>
    {% endif %}
  </div>
  
  <div class="post-content">
    {{ post.content | replace('\n', '<br>') | safe }}
  </div>
  
  <!-- Post Photos -->
  {% if post.photos %}
    {% set post_photos = post.photos|from_json %}
    {% if post_photos %}
      <div class="post-photos" style="margin-top: 16px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
          {% for photo in post_photos %}
            <div style="position: relative; border-radius: 8px; overflow: hidden; background: #1a202c;">
              <img src="/static/uploads/photos/{{ photo }}" 
                   alt="Post photo" 
                   style="width: 100%; height: 200px; object-fit: cover; display: block; cursor: pointer;"
                   onclick="openPhotoModal('/static/uploads/photos/{{ photo }}')">
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endif %}

  <!-- Post Voting Section -->
  {% if current_user.is_authenticated %}
  <div class="post-voting">
    <div class="post-votes">
      <button class="vote-btn upvote" data-post-id="{{ post.id }}" data-vote-type="upvote" data-user-vote="{{ post._user_vote or '' }}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 15l-6-6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <span class="vote-count" id="post-votes-{{ post.id }}">{{ post._total_votes }}</span>
      <button class="vote-btn downvote" data-post-id="{{ post.id }}" data-vote-type="downvote" data-user-vote="{{ post._user_vote or '' }}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
  {% endif %}

  <!-- Edit Post Form (Hidden by default) -->
  {% if current_user.is_authenticated and current_user.id == post.author_id %}
  <div id="edit-post-form" class="edit-form" style="display: none;">
    <h3>Edit Post</h3>
    <form onsubmit="submitEditPost({{ post.id }}, event)">
      <div class="form-group">
        <label for="edit-post-title">Title</label>
        <input type="text" id="edit-post-title" name="title" value="{{ post.title }}" required>
      </div>
      <div class="form-group">
        <label for="edit-post-content">Content</label>
        <textarea id="edit-post-content" name="content" rows="5" required>{{ post.content }}</textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">Save Changes</button>
        <button type="button" class="btn-secondary" onclick="hideEditPost()">Cancel</button>
      </div>
    </form>
  </div>
  {% endif %}
</div>

<!-- Comments Section -->
<div class="comments-section">
  <div class="comments-header">
    <h3>ðŸ’¬ Comments ({{ comments|length }})</h3>
    <div class="comment-sort-controls">
      <label for="comment-sort" class="sort-label">Sort by:</label>
      <select id="comment-sort" class="sort-dropdown" onchange="sortComments(this.value)">
        <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>Oldest first</option>
        <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest first</option>
        <option value="most_voted" {% if current_sort == 'most_voted' %}selected{% endif %}>Most upvoted</option>
      </select>
    </div>
  </div>

  <!-- Add Comment Form -->
  {% if current_user.is_authenticated and not post.is_locked %}
  <div class="comment-form-card">
    <form id="comment-form" onsubmit="submitComment(event)">
      <div class="form-group">
        <textarea id="comment-content" name="content" rows="3" placeholder="Write a comment..." required></textarea>
      </div>
      
      <!-- Photo Upload Section for Comments -->
      <div class="form-group">
        <label style="display:block; margin-bottom:6px; font-weight:500; color: var(--text-secondary); font-size: 11px;">Photos (Optional)</label>
        <div id="commentPhotoUploadArea" style="border: 2px dashed #4a5568; border-radius: 6px; padding: 8px; text-align: center; background: rgba(255,255,255,0.02); cursor: pointer;">
          <div id="commentPhotoUploadText">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto 4px; opacity: 0.6;">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <polyline points="17,8 12,3 7,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <p style="margin: 0; color: #888; font-size: 10px;">Click to add photos</p>
            <p style="margin: 1px 0 0; color: #666; font-size: 8px;">Max 3 photos, 5MB each</p>
          </div>
          <input type="file" id="commentPhotoInput" name="photos" multiple accept="image/*" style="display: none;">
          <input type="hidden" name="photos" id="commentPhotosData" value="[]">
        </div>
        
        <!-- Photo Preview Area for Comments -->
        <div id="commentPhotoPreview" style="margin-top: 12px; display: none;">
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px;">
            <!-- Photos will be added here dynamically -->
          </div>
        </div>
      </div>
      
      <button type="submit" class="btn-primary">Post Comment</button>
    </form>
  </div>
  {% endif %}

  <!-- Comments List -->
  <div id="comments-container">
    {% include 'forum/comments_section.html' %}
  </div>
</div>

<!-- Photo Modal -->
<div id="photoModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);">
  <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
    <span id="closePhotoModal" style="position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1001;">&times;</span>
    <img id="modalPhoto" style="max-width: 90%; max-height: 90%; object-fit: contain;">
  </div>
</div>

<style>
/* Post Card Styling */
.post-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  backdrop-filter: var(--blur);
  box-shadow: var(--shadow);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.post-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
  border-color: var(--accent);
}

.post-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-light);
}

.post-meta {
  display: flex;
  align-items: center;
  gap: 12px;
}

.post-author {
  display: flex;
  align-items: center;
  gap: 8px;
}

.author-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
  color: var(--bg);
}

.author-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.author-name {
  font-weight: 600;
  color: var(--text);
  font-size: 14px;
}

.post-date {
  color: var(--text-muted);
  font-size: 12px;
}

.post-category {
  display: flex;
  align-items: center;
}

.category-badge {
  background: var(--accent-light);
  color: var(--accent);
  padding: 4px 8px;
  border-radius: 16px;
  font-size: 11px;
  font-weight: 500;
  border: 1px solid var(--accent);
}

.specialty-badge {
  background: #10b981;
  color: white;
  padding: 4px 8px;
  border-radius: 16px;
  font-size: 11px;
  font-weight: 500;
  margin-left: 6px;
}

.post-actions {
  display: flex;
  gap: 6px;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  border: 1px solid transparent;
}

.edit-btn {
  background: var(--surface-2);
  color: var(--text-secondary);
  border-color: var(--border);
}

.edit-btn:hover {
  background: var(--accent-light);
  color: var(--accent);
  border-color: var(--accent);
}

.delete-btn {
  background: var(--surface-2);
  color: var(--notification);
  border-color: var(--border);
}

.delete-btn:hover {
  background: rgba(255, 71, 87, 0.1);
  border-color: var(--notification);
}

/* Vote Button Styling */
.vote-btn {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 8px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  min-width: 32px;
  height: 32px;
}

.vote-btn:hover {
  background: var(--surface-2);
  border-color: var(--accent);
  color: var(--accent);
  transform: translateY(-1px);
}

.vote-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: var(--bg);
}

.vote-btn.active:hover {
  background: var(--accent-dark);
  border-color: var(--accent-dark);
  transform: translateY(-1px);
}

.vote-count {
  font-weight: 600;
  font-size: 14px;
  color: var(--text);
  min-width: 20px;
  text-align: center;
}

/* Post Voting Section */
.post-voting {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border-light);
}

.post-votes {
  display: flex;
  align-items: center;
  gap: 8px;
}

.post-votes .vote-btn {
  min-width: 32px;
  height: 32px;
  font-size: 14px;
}

.post-votes .vote-count {
  font-size: 14px;
  font-weight: 700;
  min-width: 20px;
}

.post-content {
  font-size: 15px;
  line-height: 1.6;
  color: var(--text);
  white-space: pre-wrap;
}

/* Edit Form Styling */
.edit-form {
  margin-top: 16px;
  padding: 16px;
  background: var(--surface-2);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.edit-form h3 {
  margin-bottom: 16px;
  color: var(--text);
  font-size: 16px;
  font-weight: 600;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  margin-bottom: 6px;
  color: var(--text-secondary);
  font-weight: 500;
  font-size: 13px;
}

.form-group input,
.form-group textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--surface);
  color: var(--text);
  font-size: 13px;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

.form-actions {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

/* Comments Section Styling */
.comments-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: var(--blur);
  box-shadow: var(--shadow);
}

.comments-header {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-light);
}

.comments-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}

.comments-header h3 {
  color: var(--text);
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}

.comment-sort-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.sort-label {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
}

.sort-dropdown {
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--surface);
  color: var(--text);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.sort-dropdown:hover {
  border-color: var(--accent);
}

.sort-dropdown:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-light);
}

/* Ensure dropdown options are properly styled */
.sort-dropdown option {
  background-color: #2d3748 !important;
  color: #e2e8f0 !important;
  padding: 8px 12px !important;
  border: none !important;
}

.sort-dropdown option:hover {
  background-color: #4a5568 !important;
  color: #ffffff !important;
}

.sort-dropdown option:checked,
.sort-dropdown option:selected {
  background-color: var(--accent) !important;
  color: white !important;
}

.comment-form-card {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
}

.comment-form-card .form-group {
  margin-bottom: 12px;
}

.comment-form-card textarea {
  min-height: 80px;
  resize: vertical;
}

/* Button Styling */
.btn-primary {
  background: var(--accent);
  color: var(--bg);
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn-primary:hover {
  background: var(--accent-hover);
  transform: translateY(-1px);
  box-shadow: var(--accent-glow);
}

.btn-secondary {
  background: var(--surface-2);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: 500;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-secondary:hover {
  background: var(--surface-3);
  color: var(--text);
  border-color: var(--accent);
}

/* Responsive Design */
@media (max-width: 768px) {
  .post-card,
  .comments-section {
    padding: 16px;
    margin-bottom: 16px;
  }
  
  .post-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
  
  .post-actions {
    width: 100%;
    justify-content: flex-end;
  }
  
  .post-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .comments-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .comment-sort-controls {
    width: 100%;
    justify-content: flex-start;
  }
}
</style>

<script>
// Helper to get CSRF token
function getCsrfToken() {
  return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

// Post functions
function showEditPost() {
  document.getElementById('edit-post-form').style.display = 'block';
}

function hideEditPost() {
  document.getElementById('edit-post-form').style.display = 'none';
}

function submitEditPost(postId, event) {
  event.preventDefault();
  const form = event.target;
  const title = form.querySelector('input[name="title"]').value;
  const content = form.querySelector('textarea[name="content"]').value;

  fetch(`/forum/post/${postId}/edit`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: `title=${encodeURIComponent(title)}&content=${encodeURIComponent(content)}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.querySelector('h1.page-title').textContent = `ðŸ’¬ ${title}`;
      document.querySelector('.post-content').innerHTML = content.replace(/\n/g, '<br>');
      hideEditPost();
    } else {
      alert('Error editing post: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error editing post. Please try again.');
  });
}

function deletePost(postId) {
  if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
    return;
  }

  fetch(`/forum/post/${postId}/delete`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.href = '/forum'; // Redirect to forum index after deletion
    } else {
      alert('Error deleting post: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting post. Please try again.');
  });
}

// Comment functions
let commentUploadedPhotos = [];
const MAX_COMMENT_PHOTOS = 3;
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

function submitComment(event) {
  event.preventDefault();
  const content = document.getElementById('comment-content').value;
  const postId = {{ post.id }};
  const photos = JSON.stringify(commentUploadedPhotos.map(p => p.filename));

  console.log('Submitting comment:', { content, postId, photos });
  console.log('Document cookies:', document.cookie);
  console.log('Current URL:', window.location.href);
  
  // Check if user is authenticated by checking if the comment form is visible
  const commentForm = document.querySelector('#comment-form');
  if (!commentForm || commentForm.style.display === 'none') {
    console.error('User not authenticated - comment form not visible');
    alert('Please log in to post comments');
    window.location.href = '/auth/login';
    return;
  }
  
  // Test authentication by making a simple request first
  console.log('Testing authentication...');
  fetch('/api/user/profile', {
    method: 'GET',
    credentials: 'include',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    console.log('Auth test response status:', response.status);
    if (!response.ok) {
      console.error('User not authenticated - auth test failed');
      alert('Please log in to post comments');
      window.location.href = '/auth/login';
      return;
    }
    return response.json();
  })
  .then(data => {
    console.log('Auth test response data:', data);
    // Continue with comment submission
    submitCommentRequest();
  })
  .catch(error => {
    console.error('Auth test failed:', error);
    alert('Please log in to post comments');
    window.location.href = '/auth/login';
  });
  
  function submitCommentRequest() {
    fetch(`/forum/post/${postId}/comment`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-Requested-With': 'XMLHttpRequest'
      },
      credentials: 'include',
      redirect: 'manual',
      body: 'content=' + encodeURIComponent(content) + '&photos=' + encodeURIComponent(photos)
    })
    .then(response => {
      console.log('Response status:', response.status);
      console.log('Response headers:', response.headers);
      console.log('Response URL:', response.url);
      
      // Check if we got redirected to login page (status 0 means redirect was blocked)
      if (response.status === 0 || response.url.includes('/auth/login')) {
        console.error('Redirected to login page - user not authenticated');
        alert('Please log in to post comments');
        window.location.href = '/auth/login';
        return;
      }
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      return response.json();
    })
    .then(data => {
      console.log('Response data:', data);
      if (data.success) {
        document.getElementById('comment-content').value = '';
        commentUploadedPhotos = [];
        updateCommentPhotoPreview();
        updateCommentPhotosData();
        
        // Add the new comment directly to the DOM instead of reloading all comments
        addCommentToDOM(data.comment);
      } else {
        console.error('Comment submission failed:', data.error);
        alert('Error posting comment: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error posting comment:', error);
      alert('Error posting comment. Please try again. Check console for details.');
    });
  }
}

function toggleReplyForm(commentId) {
  const replyForm = document.getElementById(`reply-form-${commentId}`);
  if (!replyForm) {
    console.error('Reply form not found for comment ID:', commentId);
    return;
  }

  if (replyForm.style.display === 'none' || replyForm.style.display === '') {
    replyForm.style.display = 'block';
    const textarea = replyForm.querySelector('textarea');
    if (textarea) {
      textarea.focus();
    }
  } else {
    replyForm.style.display = 'none';
  }
}

function submitReply(commentId, event) {
  event.preventDefault();
  const form = event.target;
  const content = form.querySelector('textarea[name="content"]').value;

  if (!content.trim()) {
    alert('Please enter a reply');
    return;
  }

  // Clear any lingering photo data from previous comment operations
  if (typeof commentUploadedPhotos !== 'undefined') {
    commentUploadedPhotos = [];
  }

  fetch(`/forum/comment/${commentId}/reply`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    credentials: 'include',
    body: 'content=' + encodeURIComponent(content)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      form.querySelector('textarea[name="content"]').value = '';
      toggleReplyForm(commentId);
      // For replies, we still need to reload comments to maintain proper nesting
      reloadComments();
    } else {
      alert('Error posting reply: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error posting reply:', error);
    alert('Error posting reply. Please try again.');
  });
}

function showEditComment(commentId) {
  const editForm = document.getElementById(`edit-comment-${commentId}`);
  if (!editForm) {
    console.error('Edit form not found for comment ID:', commentId);
    return;
  }
  editForm.style.display = 'block';
}

function hideEditComment(commentId) {
  document.getElementById(`edit-comment-${commentId}`).style.display = 'none';
}

function submitEditComment(commentId, event) {
  event.preventDefault();
  const form = event.target;
  const content = form.querySelector('textarea[name="content"]').value;

  fetch(`/forum/comment/${commentId}/edit`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: 'content=' + encodeURIComponent(content)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const commentContentDiv = document.getElementById(`comment-content-${commentId}`);
      if (commentContentDiv) {
        commentContentDiv.textContent = data.comment.content;
        // Add 'Edited' tag if not already present
        let editedTag = commentContentDiv.nextElementSibling;
        if (!editedTag || !editedTag.classList.contains('comment-meta') || !editedTag.textContent.includes('(Edited)')) {
            editedTag = document.createElement('span');
            editedTag.classList.add('comment-meta');
            editedTag.style.marginLeft = '0.5rem';
            commentContentDiv.parentNode.insertBefore(editedTag, commentContentDiv.nextSibling);
        }
        editedTag.textContent = `(Edited)`;
        editedTag.style.fontStyle = 'italic';
        editedTag.style.fontSize = '0.75rem';
        editedTag.style.color = 'var(--text-muted)';
      }
      hideEditComment(commentId);
    } else {
      alert('Error editing comment: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error editing comment. Please try again.');
  });
}

function deleteComment(commentId) {
  if (!confirm('Are you sure you want to delete this comment?')) {
    return;
  }

  fetch(`/forum/comment/${commentId}/delete`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Find the comment element - check both main comments and replies
      let commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
      
      if (commentElement) {
        // Update the comment content to show [deleted]
        const contentDiv = commentElement.querySelector('.comment-text, .comment-content');
        if (contentDiv) {
          contentDiv.textContent = '[deleted]';
          contentDiv.classList.add('deleted-comment');
        }
        
        // Hide action buttons (Reply, Edit, Delete)
        const actionsDiv = commentElement.querySelector('.comment-actions, .reply-actions');
        if (actionsDiv) {
          actionsDiv.style.display = 'none';
        }
        
        // Hide edit and reply forms
        const editForm = document.getElementById(`edit-comment-${commentId}`);
        if (editForm) {
          editForm.style.display = 'none';
        }
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
          replyForm.style.display = 'none';
        }
      } else {
        // If we can't find the element, reload the comments section
        reloadComments();
      }
    } else {
      alert('Error deleting comment: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting comment. Please try again.');
  });
}

function addCommentToDOM(commentData) {
  console.log('Adding comment to DOM:', commentData);
  
  const commentsContainer = document.getElementById('comments-container');
  if (!commentsContainer) {
    console.error('Comments container not found!');
    return;
  }
  
  // Create the comment HTML
  const commentHTML = createCommentHTML(commentData);
  
  // Add the comment to the top of the comments list
  const commentsList = commentsContainer.querySelector('.comments-list');
  if (commentsList) {
    commentsList.insertAdjacentHTML('afterbegin', commentHTML);
    console.log('Comment added to DOM');
    
    // Re-attach event listeners
    attachVoteListeners();
  } else {
    console.error('Comments list not found!');
  }
}

function createCommentHTML(commentData) {
  // Use the timezone utility to format the timestamp
  const formattedDate = window.TimezoneUtils ? 
    window.TimezoneUtils.formatTimestamp(commentData.created_at, 'full') : 
    new Date(commentData.created_at).toLocaleString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
  
  let photosHTML = '';
  if (commentData.photos && commentData.photos.length > 0) {
    photosHTML = `
      <div class="comment-photos" style="margin-top: 12px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;">
          ${commentData.photos.map(photo => `
            <div style="position: relative; border-radius: 6px; overflow: hidden; background: #1a202c;">
              <img src="/static/uploads/photos/${photo}" 
                   alt="Comment photo" 
                   style="width: 100%; height: 120px; object-fit: cover; display: block; cursor: pointer;"
                   onclick="openPhotoModal('/static/uploads/photos/${photo}')">
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  return `
    <div class="comment-item" data-comment-id="${commentData.id}">
      <div class="comment-content-wrapper">
        <!-- Vote Column -->
        <div class="comment-votes">
          <button class="vote-btn upvote" data-comment-id="${commentData.id}" data-vote-type="upvote" data-user-vote="">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 15l-6-6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <span class="vote-count" id="comment-votes-${commentData.id}">0</span>
          <button class="vote-btn downvote" data-comment-id="${commentData.id}" data-vote-type="downvote" data-user-vote="">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        
        <!-- Comment Content -->
        <div class="comment-main">
          <div class="comment-header">
            <div class="comment-author">
              <div class="author-avatar-small">
                ${commentData.author_name[0].toUpperCase()}
              </div>
              <span class="author-name">${commentData.author_name}</span>
            </div>
            <div class="comment-meta">
              <span class="comment-date" data-timestamp="${commentData.created_at}" data-format="full">
                ${formattedDate}
              </span>
            </div>
          </div>
          
          <div class="comment-body">
            <div class="comment-text" id="comment-content-${commentData.id}">${commentData.content}</div>
            ${photosHTML}
          </div>
          
          <!-- Comment Actions -->
          <div class="comment-actions">
            <button class="action-btn reply-btn" onclick="toggleReplyForm(${commentData.id})">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Reply
            </button>
            <button class="action-btn edit-btn" onclick="showEditComment(${commentData.id})">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Edit
            </button>
            <button class="action-btn delete-btn" onclick="deleteComment(${commentData.id})">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Delete
            </button>
          </div>
          
          <!-- Edit Comment Form (Hidden by default) -->
          <div id="edit-comment-${commentData.id}" class="edit-form" style="display: none;">
            <form onsubmit="submitEditComment(${commentData.id}, event)">
              <div class="form-group">
                <textarea name="content" rows="3" required>${commentData.content}</textarea>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn-primary">Save</button>
                <button type="button" class="btn-secondary" onclick="hideEditComment(${commentData.id})">Cancel</button>
              </div>
            </form>
          </div>
          
          <!-- Reply Form (Hidden by default) -->
          <div id="reply-form-${commentData.id}" class="reply-form" style="display: none;">
            <div class="reply-header">
              <span>Replying to <strong>${commentData.author_name}</strong></span>
            </div>
            <form onsubmit="submitReply(${commentData.id}, event)">
              <div class="form-group">
                <textarea name="content" rows="3" placeholder="Write your reply..." required></textarea>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn-primary">Post Reply</button>
                <button type="button" class="btn-secondary" onclick="toggleReplyForm(${commentData.id})">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  `;
}

function reloadComments() {
  const postId = {{ post.id }};
  console.log('Reloading comments for post:', postId);

  fetch(`/forum/post/${postId}/comments`, {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    console.log('Comments response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.text();
  })
  .then(html => {
    console.log('Comments HTML received, length:', html.length);
    const commentsContainer = document.getElementById('comments-container');
    if (commentsContainer) {
      commentsContainer.innerHTML = html;
      console.log('Comments container updated');
      // Re-attach event listeners after reloading comments
      attachVoteListeners();
    } else {
      console.error('Comments container not found!');
    }
  })
  .catch(error => {
    console.error('Error reloading comments:', error);
    window.location.reload(); // Fallback to full page reload on error
  });
}

// Voting functionality
function attachVoteListeners() {
  // Attach vote listeners to all vote buttons
  document.querySelectorAll('.vote-btn').forEach(button => {
    button.addEventListener('click', handleVote);
  });
}

function handleVote(event) {
  event.preventDefault();
  const button = event.currentTarget;
  const commentId = button.getAttribute('data-comment-id');
  const postId = button.getAttribute('data-post-id');
  const voteType = button.getAttribute('data-vote-type');
  
  if ((!commentId && !postId) || !voteType) {
    console.error('Missing comment/post ID or vote type');
    return;
  }

  // Prepare request body
  const requestBody = { vote_type: voteType };
  if (commentId) {
    requestBody.comment_id = parseInt(commentId);
  }
  if (postId) {
    requestBody.post_id = parseInt(postId);
  }

  // Send vote request
  fetch('/forum/vote', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify(requestBody)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update vote count display
      if (commentId) {
        const voteCountElement = document.getElementById(`comment-votes-${commentId}`);
        if (voteCountElement) {
          voteCountElement.textContent = data.total_votes;
        }
        // Update comment button states
        updateVoteButtons(commentId, data.user_vote, 'comment');
      }
      
      if (postId) {
        const voteCountElement = document.getElementById(`post-votes-${postId}`);
        if (voteCountElement) {
          voteCountElement.textContent = data.total_votes;
        }
        // Update post button states
        updateVoteButtons(postId, data.user_vote, 'post');
      }
    } else {
      console.error('Vote failed:', data.error);
      alert('Error voting: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error voting:', error);
    alert('Error voting. Please try again.');
  });
}

function updateVoteButtons(itemId, userVote, type = 'comment') {
  // Update upvote and downvote buttons
  const upvoteBtn = document.querySelector(`[data-${type}-id="${itemId}"][data-vote-type="upvote"]`);
  const downvoteBtn = document.querySelector(`[data-${type}-id="${itemId}"][data-vote-type="downvote"]`);
  
  if (upvoteBtn && downvoteBtn) {
    // Remove active classes
    upvoteBtn.classList.remove('active');
    downvoteBtn.classList.remove('active');
    
    // Add active class to current vote
    if (userVote === 'upvote') {
      upvoteBtn.classList.add('active');
    } else if (userVote === 'downvote') {
      downvoteBtn.classList.add('active');
    }
  }
}

// Initialize vote listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
  attachVoteListeners();
  initializeVoteStates();
});

function initializeVoteStates() {
  // Set initial vote button states based on data attributes
  document.querySelectorAll('.vote-btn').forEach(button => {
    const commentId = button.getAttribute('data-comment-id');
    const postId = button.getAttribute('data-post-id');
    const voteType = button.getAttribute('data-vote-type');
    const userVote = button.getAttribute('data-user-vote');
    
    if (userVote === voteType) {
      button.classList.add('active');
    }
  });
}

// Comment photo upload functionality
document.addEventListener('DOMContentLoaded', function() {
  const commentPhotoInput = document.getElementById('commentPhotoInput');
  const commentPhotoUploadArea = document.getElementById('commentPhotoUploadArea');
  const commentPhotoPreview = document.getElementById('commentPhotoPreview');
  const commentPhotosData = document.getElementById('commentPhotosData');
  
  if (commentPhotoUploadArea) {
    // Click to upload
    commentPhotoUploadArea.addEventListener('click', () => {
      commentPhotoInput.click();
    });
    
    // Drag and drop
    commentPhotoUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      commentPhotoUploadArea.style.borderColor = '#00d4ff';
      commentPhotoUploadArea.style.backgroundColor = 'rgba(0, 212, 255, 0.1)';
    });
    
    commentPhotoUploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      commentPhotoUploadArea.style.borderColor = '#4a5568';
      commentPhotoUploadArea.style.backgroundColor = 'rgba(255,255,255,0.02)';
    });
    
    commentPhotoUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      commentPhotoUploadArea.style.borderColor = '#4a5568';
      commentPhotoUploadArea.style.backgroundColor = 'rgba(255,255,255,0.02)';
      
      const files = Array.from(e.dataTransfer.files);
      handleCommentFiles(files);
    });
    
    // File input change
    commentPhotoInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      handleCommentFiles(files);
    });
  }
  
  function handleCommentFiles(files) {
    if (commentUploadedPhotos.length + files.length > MAX_COMMENT_PHOTOS) {
      alert(`Maximum ${MAX_COMMENT_PHOTOS} photos allowed for comments`);
      return;
    }
    
    files.forEach(file => {
      if (!file.type.startsWith('image/')) {
        alert(`${file.name} is not an image file`);
        return;
      }
      
      if (file.size > MAX_FILE_SIZE) {
        alert(`${file.name} is too large. Maximum size is 5MB`);
        return;
      }
      
      uploadCommentPhoto(file);
    });
  }
  
  function uploadCommentPhoto(file) {
    const formData = new FormData();
    formData.append('photo', file);
    
    fetch('/api/upload-photo', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        commentUploadedPhotos.push({
          filename: data.filename,
          url: data.url,
          originalName: file.name
        });
        updateCommentPhotoPreview();
        updateCommentPhotosData();
      } else {
        alert(`Error uploading ${file.name}: ${data.error}`);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Error uploading ${file.name}`);
    });
  }
  
  // Move updateCommentPhotoPreview to global scope
  window.updateCommentPhotoPreview = function() {
    if (typeof commentUploadedPhotos === 'undefined' || commentUploadedPhotos.length === 0) {
      if (commentPhotoPreview) {
        commentPhotoPreview.style.display = 'none';
      }
      return;
    }
    
    if (commentPhotoPreview) {
      commentPhotoPreview.style.display = 'block';
      const previewContainer = commentPhotoPreview.querySelector('div');
      if (previewContainer) {
        previewContainer.innerHTML = '';
        
        commentUploadedPhotos.forEach((photo, index) => {
          const photoDiv = document.createElement('div');
          photoDiv.style.position = 'relative';
          photoDiv.style.borderRadius = '6px';
          photoDiv.style.overflow = 'hidden';
          photoDiv.style.backgroundColor = '#1a202c';
          
          photoDiv.innerHTML = `
            <img src="${photo.url}" alt="${photo.originalName}" 
                 style="width: 100%; height: 80px; object-fit: cover; display: block;">
            <button type="button" class="remove-comment-photo" 
                    style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); 
                           color: white; border: none; border-radius: 50%; width: 20px; height: 20px; 
                           cursor: pointer; font-size: 12px; display: flex; align-items: center; 
                           justify-content: center;">Ã—</button>
          `;
          
          photoDiv.querySelector('.remove-comment-photo').addEventListener('click', () => {
            removeCommentPhoto(index);
          });
          
          previewContainer.appendChild(photoDiv);
        });
      }
    }
  }
  
  // Move removeCommentPhoto to global scope
  window.removeCommentPhoto = function(index) {
    if (typeof commentUploadedPhotos === 'undefined' || !commentUploadedPhotos[index]) {
      return;
    }
    
    const photo = commentUploadedPhotos[index];
    
    // Delete from server
    fetch('/api/delete-photo', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ filename: photo.filename })
    });
    
    commentUploadedPhotos.splice(index, 1);
    updateCommentPhotoPreview();
    updateCommentPhotosData();
  }
  
  // Move updateCommentPhotosData to global scope
  window.updateCommentPhotosData = function() {
    if (typeof commentUploadedPhotos !== 'undefined' && commentPhotosData) {
      commentPhotosData.value = JSON.stringify(commentUploadedPhotos.map(p => p.filename));
    }
  }
});

// Photo modal functionality
function openPhotoModal(photoSrc) {
  const modal = document.getElementById('photoModal');
  const modalPhoto = document.getElementById('modalPhoto');
  modalPhoto.src = photoSrc;
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closePhotoModal() {
  const modal = document.getElementById('photoModal');
  modal.style.display = 'none';
  document.body.style.overflow = 'auto'; // Restore scrolling
}

// Close modal when clicking outside the image
document.getElementById('photoModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closePhotoModal();
  }
});

// Close modal with escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closePhotoModal();
  }
});

// Close modal with close button
document.getElementById('closePhotoModal').addEventListener('click', closePhotoModal);

// Comment sorting functionality
function sortComments(sortBy) {
  const postId = {{ post.id }};
  const currentUrl = new URL(window.location);
  currentUrl.searchParams.set('sort', sortBy);
  
  // Reload the page with the new sort parameter
  window.location.href = currentUrl.toString();
}
</script>
{% endblock %}