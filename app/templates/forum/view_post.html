{% extends "base.html" %}

{% block title %}{{ post.title }} - Forum{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title page-title-animated">ðŸ’¬ {{ post.title }}</h1>
</div>

<!-- Post Content Card -->
<div class="post-card">
  <div class="post-header">
    <div class="post-meta">
      <div class="post-author">
        <div class="author-avatar">
          <span>{{ post.author.name[0].upper() }}</span>
        </div>
        <div class="author-info">
          <div class="author-name">{{ post.author.name }}</div>
          <div class="post-date" data-timestamp="{{ post.created_at.isoformat() }}" data-format="full">{{ post.created_at.strftime('%B %d, %Y at %I:%M %p') }}</div>
        </div>
      </div>
      <div class="post-category">
        <span class="category-badge">{{ post.category.value.replace('_', ' ').title() }}</span>
      </div>
    </div>
    {% if current_user.is_authenticated and current_user.id == post.author_id %}
    <div class="post-actions">
      <button class="action-btn edit-btn" onclick="showEditPost()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Edit
      </button>
      <button class="action-btn delete-btn" onclick="deletePost({{ post.id }})">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Delete
      </button>
    </div>
    {% endif %}
  </div>
  
  <div class="post-content">
    {{ post.content | replace('\n', '<br>') | safe }}
  </div>

  <!-- Post Voting Section -->
  {% if current_user.is_authenticated %}
  <div class="post-voting">
    <div class="post-votes">
      <button class="vote-btn upvote" data-post-id="{{ post.id }}" data-vote-type="upvote" data-user-vote="{{ post._user_vote or '' }}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 15l-6-6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <span class="vote-count" id="post-votes-{{ post.id }}">{{ post._total_votes }}</span>
      <button class="vote-btn downvote" data-post-id="{{ post.id }}" data-vote-type="downvote" data-user-vote="{{ post._user_vote or '' }}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
  {% endif %}

  <!-- Edit Post Form (Hidden by default) -->
  {% if current_user.is_authenticated and current_user.id == post.author_id %}
  <div id="edit-post-form" class="edit-form" style="display: none;">
    <h3>Edit Post</h3>
    <form onsubmit="submitEditPost({{ post.id }}, event)">
      <div class="form-group">
        <label for="edit-post-title">Title</label>
        <input type="text" id="edit-post-title" name="title" value="{{ post.title }}" required>
      </div>
      <div class="form-group">
        <label for="edit-post-content">Content</label>
        <textarea id="edit-post-content" name="content" rows="5" required>{{ post.content }}</textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">Save Changes</button>
        <button type="button" class="btn-secondary" onclick="hideEditPost()">Cancel</button>
      </div>
    </form>
  </div>
  {% endif %}
</div>

<!-- Comments Section -->
<div class="comments-section">
  <div class="comments-header">
    <h3>ðŸ’¬ Comments ({{ comments|length }})</h3>
  </div>

  <!-- Add Comment Form -->
  {% if current_user.is_authenticated and not post.is_locked %}
  <div class="comment-form-card">
    <form id="comment-form" onsubmit="submitComment(event)">
      <div class="form-group">
        <textarea id="comment-content" name="content" rows="3" placeholder="Write a comment..." required></textarea>
      </div>
      <button type="submit" class="btn-primary">Post Comment</button>
    </form>
  </div>
  {% endif %}

  <!-- Comments List -->
  <div id="comments-container">
    {% include 'forum/comments_section.html' %}
  </div>
</div>

<style>
/* Post Card Styling */
.post-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  backdrop-filter: var(--blur);
  box-shadow: var(--shadow);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.post-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
  border-color: var(--accent);
}

.post-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-light);
}

.post-meta {
  display: flex;
  align-items: center;
  gap: 12px;
}

.post-author {
  display: flex;
  align-items: center;
  gap: 8px;
}

.author-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
  color: var(--bg);
}

.author-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.author-name {
  font-weight: 600;
  color: var(--text);
  font-size: 14px;
}

.post-date {
  color: var(--text-muted);
  font-size: 12px;
}

.post-category {
  display: flex;
  align-items: center;
}

.category-badge {
  background: var(--accent-light);
  color: var(--accent);
  padding: 4px 8px;
  border-radius: 16px;
  font-size: 11px;
  font-weight: 500;
  border: 1px solid var(--accent);
}

.post-actions {
  display: flex;
  gap: 6px;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  border: 1px solid transparent;
}

.edit-btn {
  background: var(--surface-2);
  color: var(--text-secondary);
  border-color: var(--border);
}

.edit-btn:hover {
  background: var(--accent-light);
  color: var(--accent);
  border-color: var(--accent);
}

.delete-btn {
  background: var(--surface-2);
  color: var(--notification);
  border-color: var(--border);
}

.delete-btn:hover {
  background: rgba(255, 71, 87, 0.1);
  border-color: var(--notification);
}

/* Vote Button Styling */
.vote-btn {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 8px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  min-width: 32px;
  height: 32px;
}

.vote-btn:hover {
  background: var(--surface-2);
  border-color: var(--accent);
  color: var(--accent);
  transform: translateY(-1px);
}

.vote-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: var(--bg);
}

.vote-btn.active:hover {
  background: var(--accent-dark);
  border-color: var(--accent-dark);
  transform: translateY(-1px);
}

.vote-count {
  font-weight: 600;
  font-size: 14px;
  color: var(--text);
  min-width: 20px;
  text-align: center;
}

/* Post Voting Section */
.post-voting {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border-light);
}

.post-votes {
  display: flex;
  align-items: center;
  gap: 8px;
}

.post-votes .vote-btn {
  min-width: 32px;
  height: 32px;
  font-size: 14px;
}

.post-votes .vote-count {
  font-size: 14px;
  font-weight: 700;
  min-width: 20px;
}

.post-content {
  font-size: 15px;
  line-height: 1.6;
  color: var(--text);
  white-space: pre-wrap;
}

/* Edit Form Styling */
.edit-form {
  margin-top: 16px;
  padding: 16px;
  background: var(--surface-2);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.edit-form h3 {
  margin-bottom: 16px;
  color: var(--text);
  font-size: 16px;
  font-weight: 600;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  margin-bottom: 6px;
  color: var(--text-secondary);
  font-weight: 500;
  font-size: 13px;
}

.form-group input,
.form-group textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--surface);
  color: var(--text);
  font-size: 13px;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

.form-actions {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

/* Comments Section Styling */
.comments-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: var(--blur);
  box-shadow: var(--shadow);
}

.comments-header {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-light);
}

.comments-header h3 {
  color: var(--text);
  font-size: 18px;
  font-weight: 600;
}

.comment-form-card {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
}

.comment-form-card .form-group {
  margin-bottom: 12px;
}

.comment-form-card textarea {
  min-height: 80px;
  resize: vertical;
}

/* Button Styling */
.btn-primary {
  background: var(--accent);
  color: var(--bg);
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn-primary:hover {
  background: var(--accent-hover);
  transform: translateY(-1px);
  box-shadow: var(--accent-glow);
}

.btn-secondary {
  background: var(--surface-2);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: 500;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-secondary:hover {
  background: var(--surface-3);
  color: var(--text);
  border-color: var(--accent);
}

/* Responsive Design */
@media (max-width: 768px) {
  .post-card,
  .comments-section {
    padding: 16px;
    margin-bottom: 16px;
  }
  
  .post-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
  
  .post-actions {
    width: 100%;
    justify-content: flex-end;
  }
  
  .post-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
}
</style>

<script>
// Helper to get CSRF token
function getCsrfToken() {
  return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

// Post functions
function showEditPost() {
  document.getElementById('edit-post-form').style.display = 'block';
}

function hideEditPost() {
  document.getElementById('edit-post-form').style.display = 'none';
}

function submitEditPost(postId, event) {
  event.preventDefault();
  const form = event.target;
  const title = form.querySelector('input[name="title"]').value;
  const content = form.querySelector('textarea[name="content"]').value;

  fetch(`/forum/post/${postId}/edit`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: `title=${encodeURIComponent(title)}&content=${encodeURIComponent(content)}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.querySelector('h1.page-title').textContent = `ðŸ’¬ ${title}`;
      document.querySelector('.post-content').innerHTML = content.replace(/\n/g, '<br>');
      hideEditPost();
    } else {
      alert('Error editing post: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error editing post. Please try again.');
  });
}

function deletePost(postId) {
  if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
    return;
  }

  fetch(`/forum/post/${postId}/delete`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.href = '/forum'; // Redirect to forum index after deletion
    } else {
      alert('Error deleting post: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting post. Please try again.');
  });
}

// Comment functions
function submitComment(event) {
  event.preventDefault();
  const content = document.getElementById('comment-content').value;
  const postId = {{ post.id }};

  fetch(`/forum/post/${postId}/comment`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: 'content=' + encodeURIComponent(content)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.getElementById('comment-content').value = '';
      reloadComments(); // Reload all comments to ensure nesting and order
    } else {
      alert('Error posting comment: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error posting comment. Please try again.');
  });
}

function toggleReplyForm(commentId) {
  const replyForm = document.getElementById(`reply-form-${commentId}`);
  if (!replyForm) {
    console.error('Reply form not found for comment ID:', commentId);
    return;
  }

  if (replyForm.style.display === 'none' || replyForm.style.display === '') {
    replyForm.style.display = 'block';
    const textarea = replyForm.querySelector('textarea');
    if (textarea) {
      textarea.focus();
    }
  } else {
    replyForm.style.display = 'none';
  }
}

function submitReply(commentId, event) {
  event.preventDefault();
  const form = event.target;
  const content = form.querySelector('textarea[name="content"]').value;

  if (!content.trim()) {
    alert('Please enter a reply');
    return;
  }

  fetch(`/forum/comment/${commentId}/reply`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: 'content=' + encodeURIComponent(content)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      form.querySelector('textarea[name="content"]').value = '';
      toggleReplyForm(commentId);
      reloadComments(); // Reload all comments to ensure nesting and order
    } else {
      alert('Error posting reply: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error posting reply. Please try again.');
  });
}

function showEditComment(commentId) {
  const editForm = document.getElementById(`edit-comment-${commentId}`);
  if (!editForm) {
    console.error('Edit form not found for comment ID:', commentId);
    return;
  }
  editForm.style.display = 'block';
}

function hideEditComment(commentId) {
  document.getElementById(`edit-comment-${commentId}`).style.display = 'none';
}

function submitEditComment(commentId, event) {
  event.preventDefault();
  const form = event.target;
  const content = form.querySelector('textarea[name="content"]').value;

  fetch(`/forum/comment/${commentId}/edit`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: 'content=' + encodeURIComponent(content)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const commentContentDiv = document.getElementById(`comment-content-${commentId}`);
      if (commentContentDiv) {
        commentContentDiv.textContent = data.comment.content;
        // Add 'Edited' tag if not already present
        let editedTag = commentContentDiv.nextElementSibling;
        if (!editedTag || !editedTag.classList.contains('comment-meta') || !editedTag.textContent.includes('(Edited)')) {
            editedTag = document.createElement('span');
            editedTag.classList.add('comment-meta');
            editedTag.style.marginLeft = '0.5rem';
            commentContentDiv.parentNode.insertBefore(editedTag, commentContentDiv.nextSibling);
        }
        editedTag.textContent = `(Edited)`;
        editedTag.style.fontStyle = 'italic';
        editedTag.style.fontSize = '0.75rem';
        editedTag.style.color = 'var(--text-muted)';
      }
      hideEditComment(commentId);
    } else {
      alert('Error editing comment: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error editing comment. Please try again.');
  });
}

function deleteComment(commentId) {
  if (!confirm('Are you sure you want to delete this comment?')) {
    return;
  }

  fetch(`/forum/comment/${commentId}/delete`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Find the comment element - check both main comments and replies
      let commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
      
      if (commentElement) {
        // Update the comment content to show [deleted]
        const contentDiv = commentElement.querySelector('.comment-text, .comment-content');
        if (contentDiv) {
          contentDiv.textContent = '[deleted]';
          contentDiv.classList.add('deleted-comment');
        }
        
        // Hide action buttons (Reply, Edit, Delete)
        const actionsDiv = commentElement.querySelector('.comment-actions, .reply-actions');
        if (actionsDiv) {
          actionsDiv.style.display = 'none';
        }
        
        // Hide edit and reply forms
        const editForm = document.getElementById(`edit-comment-${commentId}`);
        if (editForm) {
          editForm.style.display = 'none';
        }
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
          replyForm.style.display = 'none';
        }
      } else {
        // If we can't find the element, reload the comments section
        reloadComments();
      }
    } else {
      alert('Error deleting comment: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting comment. Please try again.');
  });
}

function reloadComments() {
  const postId = {{ post.id }};

  fetch(`/forum/post/${postId}/comments`, {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.text())
  .then(html => {
    const commentsContainer = document.getElementById('comments-container');
    if (commentsContainer) {
      commentsContainer.innerHTML = html;
      // Re-attach event listeners after reloading comments
      attachVoteListeners();
    }
  })
  .catch(error => {
    console.error('Error reloading comments:', error);
    window.location.reload(); // Fallback to full page reload on error
  });
}

// Voting functionality
function attachVoteListeners() {
  // Attach vote listeners to all vote buttons
  document.querySelectorAll('.vote-btn').forEach(button => {
    button.addEventListener('click', handleVote);
  });
}

function handleVote(event) {
  event.preventDefault();
  const button = event.currentTarget;
  const commentId = button.getAttribute('data-comment-id');
  const postId = button.getAttribute('data-post-id');
  const voteType = button.getAttribute('data-vote-type');
  
  if ((!commentId && !postId) || !voteType) {
    console.error('Missing comment/post ID or vote type');
    return;
  }

  // Prepare request body
  const requestBody = { vote_type: voteType };
  if (commentId) {
    requestBody.comment_id = parseInt(commentId);
  }
  if (postId) {
    requestBody.post_id = parseInt(postId);
  }

  // Send vote request
  fetch('/forum/vote', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify(requestBody)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update vote count display
      if (commentId) {
        const voteCountElement = document.getElementById(`comment-votes-${commentId}`);
        if (voteCountElement) {
          voteCountElement.textContent = data.total_votes;
        }
        // Update comment button states
        updateVoteButtons(commentId, data.user_vote, 'comment');
      }
      
      if (postId) {
        const voteCountElement = document.getElementById(`post-votes-${postId}`);
        if (voteCountElement) {
          voteCountElement.textContent = data.total_votes;
        }
        // Update post button states
        updateVoteButtons(postId, data.user_vote, 'post');
      }
    } else {
      console.error('Vote failed:', data.error);
      alert('Error voting: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error voting:', error);
    alert('Error voting. Please try again.');
  });
}

function updateVoteButtons(itemId, userVote, type = 'comment') {
  // Update upvote and downvote buttons
  const upvoteBtn = document.querySelector(`[data-${type}-id="${itemId}"][data-vote-type="upvote"]`);
  const downvoteBtn = document.querySelector(`[data-${type}-id="${itemId}"][data-vote-type="downvote"]`);
  
  if (upvoteBtn && downvoteBtn) {
    // Remove active classes
    upvoteBtn.classList.remove('active');
    downvoteBtn.classList.remove('active');
    
    // Add active class to current vote
    if (userVote === 'upvote') {
      upvoteBtn.classList.add('active');
    } else if (userVote === 'downvote') {
      downvoteBtn.classList.add('active');
    }
  }
}

// Initialize vote listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
  attachVoteListeners();
  initializeVoteStates();
});

function initializeVoteStates() {
  // Set initial vote button states based on data attributes
  document.querySelectorAll('.vote-btn').forEach(button => {
    const commentId = button.getAttribute('data-comment-id');
    const postId = button.getAttribute('data-post-id');
    const voteType = button.getAttribute('data-vote-type');
    const userVote = button.getAttribute('data-user-vote');
    
    if (userVote === voteType) {
      button.classList.add('active');
    }
  });
}
</script>
{% endblock %}