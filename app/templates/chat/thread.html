{% extends "base.html" %}
{% block content %}
  <div class="job-card" style="padding:16px; background: #2d3748;">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
      <div style="display:flex; align-items:center; gap:10px; min-width:50px;">
        {% if other_user_profile and other_user_profile.photo_filename %}
          <img src="/uploads/{{ other_user_profile.photo_filename }}" alt="{{ other_user.name }}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
        {% else %}
          <div style="width:40px; height:40px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; color:white; font-size:16px; font-weight:600;">
            {{ other_user.name[0].upper() }}
          </div>
        {% endif %}
      </div>
      <div>
        <div style="font-weight:500; font-size:14px;">
          Chat with 
          {% if current_user.role.value == 'employer' and other_user.role.value == 'resident' %}
            <a href="/profile/{{ other_user.id }}" style="color:var(--accent); text-decoration:none;">{{ other_user.name }}</a>
          {% else %}
            {{ other_user.name }}
          {% endif %}
        </div>
      </div>
    </div>
    <div style="margin:10px 0; max-height:46vh; overflow:auto; border:1px solid var(--border); border-radius:8px; padding:10px; background: rgba(17,24,39,0.6)">
      {% for m in msgs %}
        <div style="margin-bottom:12px;">
          <div style="display:flex; align-items:flex-start; gap:10px;">
            <div style="display:flex; align-items:center; gap:6px; min-width:36px;">
              {% if m.sender_id == current_user.id %}
                {% if current_user_profile and current_user_profile.photo_filename %}
                  <img src="/uploads/{{ current_user_profile.photo_filename }}" alt="You" style="width:28px; height:28px; border-radius:50%; object-fit:cover;">
                {% else %}
                  <div style="width:28px; height:28px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; color:white; font-size:11px; font-weight:600;">
                    {{ current_user.name[0].upper() }}
                  </div>
                {% endif %}
              {% else %}
                {% if other_user_profile and other_user_profile.photo_filename %}
                  <img src="/uploads/{{ other_user_profile.photo_filename }}" alt="{{ other_user.name }}" style="width:28px; height:28px; border-radius:50%; object-fit:cover;">
                {% else %}
                  <div style="width:28px; height:28px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; color:white; font-size:11px; font-weight:600;">
                    {{ other_user.name[0].upper() }}
                  </div>
                {% endif %}
              {% endif %}
            </div>
            <div style="flex-grow:1;">
              <div class="muted" style="font-size:11px; margin-bottom:3px;" data-timestamp="{{ m.created_at.isoformat() }}" data-format="time">{{ m.created_at.strftime('%I:%M %p') }}</div>
              <div style="font-size: 13px;">
                {% if m.sender_id == current_user.id %}
                  <strong>You:</strong>
                {% else %}
                  <strong>
                    {% if current_user.role.value == 'employer' and other_user.role.value == 'resident' %}
                      <a href="/profile/{{ other_user.id }}" style="color:var(--accent); text-decoration:none;">{{ other_user.name }}</a>:
                    {% else %}
                      {{ other_user.name }}:
                    {% endif %}
                  </strong>
                {% endif %}
                {{ m.body }}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
      {% if not msgs %}
        <div class="muted" style="font-size: 12px;">No messages yet. Say hello!</div>
      {% endif %}
    </div>
    <form method="POST" style="display:flex; gap:8px;">
      <input class="input" type="text" name="body" placeholder="Type your message..." style="padding: 0.5rem; font-size: 0.9rem;" />
      <button class="btn" type="submit" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Send</button>
    </form>
  </div>

<script>
// Real-time message updates for thread page
let threadEventSource = null;
const conversationId = {{ convo.id }};
const currentUserId = {{ current_user.id }};
const otherUserId = {{ other_user.id }};

function startThreadMessageStream() {
  // Close existing connection if any
  if (threadEventSource) {
    threadEventSource.close();
  }
  
  // Create new EventSource connection
  threadEventSource = new EventSource('/api/messages/stream');
  
  threadEventSource.onmessage = function(event) {
    try {
      const data = JSON.parse(event.data);
      
      if (data.type === 'new_messages') {
        // Find messages for this conversation
        const conversation = data.conversations.find(conv => conv.id === conversationId);
        
        if (conversation) {
          // Check if there are new messages by comparing with current message count
          const currentMessageCount = document.querySelectorAll('.message-item').length;
          
          // If we have new messages, reload the page to show them
          // This is simpler than trying to dynamically add messages to the existing layout
          if (conversation.last_message && conversation.last_message.sender_id !== currentUserId) {
            // Only reload if the new message is from the other user
            console.log('New message received, reloading page...');
            window.location.reload();
          }
        }
      }
    } catch (error) {
      console.error('Error processing real-time message in thread:', error);
    }
  };
  
  threadEventSource.onerror = function(event) {
    console.error('Thread EventSource failed:', event);
    // Attempt to reconnect after 5 seconds
    setTimeout(() => {
      console.log('Attempting to reconnect to thread message stream...');
      startThreadMessageStream();
    }, 5000);
  };
  
  threadEventSource.onopen = function(event) {
    console.log('Thread message stream connected');
  };
}

// Start the message stream when page loads
document.addEventListener('DOMContentLoaded', function() {
  startThreadMessageStream();
});

// Cleanup when page unloads
window.addEventListener('beforeunload', function() {
  if (threadEventSource) {
    threadEventSource.close();
  }
});
</script>
{% endblock %}
