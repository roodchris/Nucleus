{% extends "base.html" %}
{% block content %}
  <div class="job-card" style="padding:24px; {% if opp.is_filled or not opp.is_active %}opacity:0.6;{% endif %}">
    <h2 style="margin-top:0;">{{ opp.title }}</h2>
    <div class="muted">{{ opp.zip_code }}{% if get_zip_location(opp.zip_code) %} ({{ get_zip_location(opp.zip_code) }}){% endif %} ¬∑ {{ opp.opportunity_type.value|replace('_',' ') }}</div>
    <div style="margin-top:8px;">$ {{ opp.pay_amount }}{% if opp.pay_type %}{% if opp.pay_type.value == 'per_hour' %}/hr{% elif opp.pay_type.value == 'per_rvu' %}/RVU{% endif %}{% else %}/hr{% endif %}</div>
    <div>Training Level: {{ opp.pgy_min.value }} - {{ opp.pgy_max.value }}</div>
    {% if opp.timezone %}
      <div class="muted">üïê Timezone: {{ opp.timezone.replace('_', ' ').replace('/', ' - ') }}</div>
    {% endif %}
    {% if opp.work_duration %}
      <div class="muted">‚è±Ô∏è Work Duration: {% if opp.work_duration.value == 'single_shift' %}Single Shift{% elif opp.work_duration.value == 'short_term' %}Short-term (less than 1 month){% elif opp.work_duration.value == 'medium_term' %}Medium-term (1 month to 6 months){% elif opp.work_duration.value == 'permanent' %}Permanent Employment{% else %}{{ opp.work_duration.value.replace('_', ' ').title() }}{% endif %}</div>
    {% endif %}
    
    {% if opp.is_filled or not opp.is_active %}
      <div style="margin-top:16px; padding:12px; background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); border-radius:8px; color:#ef4444;">
        {% if opp.is_filled %}
          ‚ö†Ô∏è This position has been filled
        {% else %}
          ‚ö†Ô∏è This opportunity is no longer active
        {% endif %}
      </div>
    {% endif %}
    
    {% if opp.description %}
      <p style="margin-top:12px; white-space:pre-wrap;">{{ opp.description }}</p>
    {% endif %}
    
    <!-- Application Status for Physicians -->
    {% if current_user.is_authenticated and current_user.role.value == 'resident' %}
      {% set application = opp.applications|selectattr("resident_id", "equalto", current_user.id)|first %}
      {% if application %}
        <div style="margin-top:16px; padding:16px; background:rgba(17,24,39,0.6); border-radius:8px; border:1px solid var(--border);">
          <h4 style="margin-top:0;">Application Status</h4>
          {% if application.status.value == 'pending' %}
            <span style="background:#f59e0b; color:white; padding:4px 12px; border-radius:20px; font-size:14px; font-weight:500;">Pending</span>
          {% elif application.status.value == 'accepted' %}
            <span style="background:#10b981; color:white; padding:4px 12px; border-radius:20px; font-size:14px; font-weight:500;">Accepted</span>
          {% elif application.status.value == 'rejected' %}
            <span style="background:#ef4444; color:white; padding:4px 12px; border-radius:20px; font-size:14px; font-weight:500;">Rejected</span>
          {% endif %}
          
          {% if application.decision_notes %}
            <div style="margin-top:12px;">
              <strong>Notes:</strong> {{ application.decision_notes }}
            </div>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}
    
    <div style="margin-top:16px; display:flex; gap:12px; flex-wrap:wrap;">
      <a href="/opportunities/{{ opp.id }}/calendar" class="btn" style="background:rgba(45,212,191,0.2); color:var(--accent);">üìÖ View Calendar</a>
      
      {% if current_user.is_authenticated %}
        {% if current_user.role.value == 'resident' %}
          {% if not application and opp.is_active and not opp.is_filled %}
            <form method="POST" action="/opportunities/{{ opp.id }}/apply" style="display:inline;">
              <button type="submit" class="btn">Apply Now</button>
            </form>
          {% elif application %}
            <a class="btn" href="/messages/start?opportunity_id={{ opp.id }}&employer_id={{ opp.employer_id }}">Message employer</a>
          {% endif %}
        {% elif current_user.role.value == 'employer' %}
          {% if current_user.id == opp.employer_id %}
            <div class="muted">This is your opportunity</div>
            <form method="POST" action="/opportunities/{{ opp.id }}/delete" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this opportunity?')">
              <button type="submit" class="btn" style="background:#ef4444;">Delete Opportunity</button>
            </form>
          {% else %}
            <a class="btn" href="/messages/start?opportunity_id={{ opp.id }}&employer_id={{ opp.employer_id }}">Message employer</a>
          {% endif %}
        {% endif %}
      {% else %}
        <a class="btn" href="/auth/login">Login to apply</a>
      {% endif %}
    </div>
    
    {% if current_user.is_authenticated and current_user.role.value == 'employer' and current_user.id == opp.employer_id %}
      <div style="margin-top:16px;">
        <h4>Applications</h4>
        {% if opp.applications %}
          <p class="muted">{{ opp.applications|length }} application(s) received</p>
          <a href="/employer/applications" class="btn">Review Applications</a>
        {% else %}
          <p class="muted">No applications received yet</p>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endblock %}
